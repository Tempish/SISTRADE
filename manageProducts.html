<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Add product</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-warning-subtle">

    <div class="container py-5">
        <h1 class="mb-5" id="formTitulo">Agregar producto a su cuenta</h1>

        <img src="assets/imgs/sistradelogo.png" alt="logo"
            class="img-fluid position-absolute start-50 translate-middle-x logo-sistrade" />

        <div class="card p-4 mb-4">
            <form id="addProductForm">

                <input type="hidden" id="idProducto">
                <div class="mb-3">
                    <label for="prodcuctName" class="form-label">Nombre del producto</label>
                    <input type="text" class="form-control" id="productName" required>
                </div>

                <div class="mb-3">
                    <label for="marketPrice" class="form-label">Precio del mercado</label>
                    <input type="number" step="any" class="form-control" id="marketPrice" required>
                </div>

                <div class="mb-3">
                    <label for="type" class="form-label">Tipo</label>
                    <input type="text" class="form-control" id="type" required>
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Descripcion</label>
                    <input type="text" class="form-control" id="description" required>
                </div>


                <div class="row">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn custom-btn mb-2" id="btnGuardar">Agregar producto</button>


                    </div>
                    <div class="col-md-6">
                        <button onclick="window.location.href='index.html'" type="button" class="btn custom-btn"
                            id="btnBack">Volver a inicio</button>

                    </div>

                </div>

            </form>
        </div>

        <div class="card p-4">
            <h4>Lista de Productos en posesion </h4>
            <table class="table table-bordered mt-3 ">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Precio mercado</th>
                        <th>Tipo</th>
                        <th>Descripcion</th>

                    </tr>
                </thead>
                <tbody id="tablaProductos"></tbody>
            </table>

        </div>
    </div>



    </div>




    <script>
        const registerProductUrl = "http://localhost:8080/api/product";
        const apiUrl = "http://localhost:8080/api/product";

        document.getElementById("addProductForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const name = document.getElementById("productName").value;
            const marketPrice = parseFloat(document.getElementById("marketPrice").value);
            const type = document.getElementById("type").value;
            const description = document.getElementById("description").value;
            const ownerId = parseInt(localStorage.getItem('userId'));
            const id = parseInt(document.getElementById("idProducto").value);
            //editar
            if (id) {
                
                fetch(`${apiUrl}/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({  ownerId, marketPrice, name, type, description })
                })
                    .then(res => res.json())
                    .then(data => {
                        alert("Producto actualizado con éxito");
                        resetFormulario();
                        cargarProductos();
                    });
            } else {
                
                fetch(registerProductUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ownerId, marketPrice, name, type, description })
            })
                .then(res => {
                    if (!res.ok) return res.text().then(msg => { throw new Error(msg); });
                    return res.json();
                })
                .then(data => {
                    alert("producto registrado con éxito");
                    document.getElementById("addProductForm").reset();
                    resetFormulario();
                    cargarProductos();
                })
                .catch(err => {
                    alert("Error: " + err.message);
                });

}

        });

        //para cargar producto al formulario
        function editarProducto(id) {
            fetch(`${apiUrl}/${id}`)
                .then(res => res.json())
                .then(producto => {

                    document.getElementById("productName").value = producto.name;
                    document.getElementById("marketPrice").value = producto.marketPrice;
                    document.getElementById("type").value = producto.type;
                    document.getElementById("description").value = producto.description;

                    document.getElementById("idProducto").value  = producto.id;
                    document.getElementById("formTitulo").innerText = "Editar producto";
                    document.getElementById("btnGuardar").innerText = "Actualizar";
                });
        }

        //cargarlos desde backend
        function cargarProductos() {

            const userId = parseInt(localStorage.getItem('userId'));
            fetch(apiUrl)
                .then(res => res.json())
                .then(productos => {
                    const tabla = document.getElementById("tablaProductos");
                    tabla.innerHTML = "";


                    const productosFiltrados = productos.filter(p => p.ownerId === userId);
                    productosFiltrados.forEach(producto => {
                        tabla.innerHTML += `
              <tr>
                <td>${producto.name}</td>
                <td>${producto.marketPrice}</td>
                <td>${producto.type}</td>
                <td>${producto.description}</td>
                
                <td>
                  <button class="btn custom-btn btn-sm" onclick="editarProducto(${producto.id})">Editar</button>
                  <button class="btn custom-btn btn-sm" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                </td>
              </tr>`;
                    });
                });
        }




        // eliminar
        function eliminarProducto(id) {
            if (confirm("¿Está seguro que desea eliminar este producto?")) {
                fetch(`${apiUrl}/${id}`,
                    { method: "DELETE" })
                    .then(() => {
                        alert("Producto Eliminado corectamente");
                        cargarProductos();
                    });
            }
        }




        // volver a agregar
        function resetFormulario() {
            document.getElementById("addProductForm").reset();
            document.getElementById("idProducto").value = "";
            document.getElementById("formTitulo").innerText = "Agregar producto a su cuenta";
            document.getElementById("btnGuardar").innerText = "Agregar producto";
        }


        window.onload = () => {
            resetFormulario();
            cargarProductos();
        };
    </script>
</body>

</html>